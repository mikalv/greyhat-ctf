#!/usr/bin/bash
/usr/bin/sudo /usr/bin/mount -t aufs -o br=$SESSION_WRITE_FS=rw:/{{ctfchroot}}=ro -o udba=reval none $SESSION_FS > /dev/null 2>&1
/usr/bin/sudo /usr/bin/mount -o bind,ro /levels $SESSION_FS/levels > /dev/null 2>&1
# NOTE: The write access is needed to let people append to iwashere.txt
/usr/bin/sudo /usr/bin/mount -o bind,rw /home $SESSION_FS/home > /dev/null 2>&1

export CTFUSER_HOME=/home/$USER

# Debug
#/usr/bin/echo "[+] Entering $SESSION_FS via chroot"

# The user's session
/usr/bin/termrec -f ttyrec -e "/usr/bin/sudo /usr/bin/ctfmod-arch-chroot $SESSION_FS /usr/bin/zsh -l" {{ctfbigbrother_log_dir}}/`/usr/bin/basename $SESSION_WRITE_FS`.ttyrec

# Bye message
/usr/bin/echo "Bye hacker, BigBrother is always watching :)"

# Disabled while debugging.
/usr/bin/sudo /usr/bin/umount $SESSION_FS/home && \
/usr/bin/sudo /usr/bin/umount $SESSION_FS/levels && \
/usr/bin/sudo /usr/bin/umount $SESSION_FS > /dev/null 2>&1
