#!/usr/bin/bash

# add logger options when needed
log="logger -t ctfssh-wrapper"

# find IP address
ip=`echo $SSH_CONNECTION | cut -d " " -f 1`

# Make unique hash for current session
export SESSION_ID=`{ echo "$SSH_CONNECTION" | sha256sum | awk '{ print $1 }' & date; } | head -c 7`
export SESSION_FS=/tmp/$SESSION_ID
mkdir -p $SESSION_FS

export SESSION_WRITE_ID=`echo "$SESSION_ID+$(date)" | sha256sum | awk '{ print $1 }' | head -c 7`
export SESSION_WRITE_FS=/tmp/$SESSION_WRITE_ID
mkdir -p $SESSION_WRITE_FS

export SSH_CMD_ALTERNATIVE="sudo /usr/local/bin/newctfsession.sh"

$log $USER login from $ip
espeak "session-start: $USER just logged in from $ip" > /dev/null 2>&1

export SESSION_USER=$USER

$log command: ${SSH_ORIGINAL_COMMAND:-$SSH_CMD_ALTERNATIVE}
$log forcedcommand: $SSH_CMD_ALTERNATIVE
$SSH_CMD_ALTERNATIVE

$log $USER logout
espeak "session-stop: $USER just logged out" > /dev/null 2>&1
